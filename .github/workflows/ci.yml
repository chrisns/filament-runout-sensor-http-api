name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

    - name: Set up Python 3.11
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: Run unit tests
      run: |
        pytest tests/unit/test_simple_models.py tests/unit/test_simple_services.py -v --tb=short --no-header

    - name: Run linting
      run: |
        ruff check src/ tests/ || true

    - name: Test model imports
      run: |
        python -c "from src.models.sensor_reading import SensorReading; print('SensorReading imported')"
        python -c "from src.models.sensor_configuration import SensorConfiguration; print('SensorConfiguration imported')"
        python -c "from src.models.session_metrics import SessionMetrics; print('SessionMetrics imported')"
        python -c "from src.models.alert_event import AlertEvent; print('AlertEvent imported')"

  build:
    runs-on: windows-latest
    needs: test

    steps:
    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

    - name: Set up Python
      uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify model structure
      run: |
        python -c "from src.models.sensor_reading import SensorReading; r = SensorReading(sensor_id=1, has_filament=True, is_moving=False, distance_mm=0, pulse_count=0); print(f'Created reading: {r.filament_status}')"
        python -c "from src.models.sensor_configuration import SensorConfiguration; c = SensorConfiguration(); print(f'Config polling: {c.polling.polling_interval_ms}ms')"
        python -c "from src.models.session_metrics import SessionMetrics; m = SessionMetrics(); print(f'Session metrics created with {m.active_sensors} active sensors')"