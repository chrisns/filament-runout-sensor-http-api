<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Sensor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .status-item {
            text-align: center;
            padding: 10px;
            min-width: 150px;
        }

        .status-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .sensors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .sensor-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4ade80, #22d3ee);
            transition: all 0.3s ease;
        }

        .sensor-card.no-filament::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            height: 6px;
        }

        .sensor-card.moving::before {
            animation: slideAnimation 2s linear infinite;
        }

        @keyframes slideAnimation {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .sensor-header {
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-number {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .sensor-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }

        .sensor-stat:last-child {
            border-bottom: none;
        }

        .sensor-stat:hover {
            padding-left: 10px;
            background: rgba(255,255,255,0.05);
            margin: 0 -10px;
            padding-right: 10px;
        }

        .sensor-label {
            opacity: 0.8;
            display: flex;
            align-items: center;
        }

        .sensor-value {
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-ok {
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .status-warning {
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .status-error {
            color: #ef4444;
            animation: pulse 1s infinite;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        .moving-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
            background: #4ade80;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        .speed-bar {
            height: 25px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }

        .speed-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22d3ee);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .speed-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .speed-text {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .chart-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .activity-log {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px;
            margin: 2px 0;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .connected-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            animation: breathe 2s infinite;
        }

        .connected-dot.connected {
            background: #4ade80;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
        }

        .connected-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.8);
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Hide elements during updates to prevent flicker */
        .updating {
            transition: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üéØ Filament Sensor Monitor
            <span id="connection-dot" class="connected-dot disconnected"></span>
        </h1>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Connection</div>
                <div class="status-value" id="connection-status">Connecting...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Uptime</div>
                <div class="status-value" id="uptime">00:00:00</div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Usage</div>
                <div class="status-value" id="total-usage">0.000m</div>
            </div>
            <div class="status-item">
                <div class="status-label">Active Sensors</div>
                <div class="status-value" id="active-sensors">0/2</div>
            </div>
        </div>

        <div class="sensors" id="sensors-container">
            <!-- Sensor cards will be dynamically inserted here -->
        </div>

        <div class="error-message" id="error-message" style="display: none;">
            <strong>‚ö†Ô∏è Connection Error</strong><br>
            Cannot connect to monitor API<br>
            Make sure monitor.py is running
        </div>

        <div class="activity-log" id="activity-log" style="display: none;">
            <strong>Activity Log:</strong>
            <div id="log-entries"></div>
        </div>

        <div class="footer">
            API Endpoint: <a href="/status" style="color: white;">/status</a> |
            Updates: <span id="update-rate">Live</span> |
            Last Response: <span id="last-response">Never</span>
        </div>
    </div>

    <script>
        // Global state
        let errorCount = 0;
        let lastData = null;
        let updateInterval = null;
        let activityLog = [];
        const maxLogEntries = 10;

        // Utility functions
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        function addLogEntry(message) {
            const timestamp = formatTime(new Date());
            activityLog.unshift(`${timestamp} - ${message}`);
            if (activityLog.length > maxLogEntries) {
                activityLog.pop();
            }
            updateActivityLog();
        }

        function updateActivityLog() {
            const logContainer = document.getElementById('log-entries');
            if (logContainer) {
                logContainer.innerHTML = activityLog.map(entry =>
                    `<div class="log-entry">${entry}</div>`
                ).join('');
            }
        }

        // Create or update sensor card
        function createSensorCard(sensor) {
            const filamentStatus = sensor.has_filament ?
                '<span class="status-ok">‚úì Filament OK</span>' :
                '<span class="status-error">‚úó NO FILAMENT!</span>';

            const movingStatus = sensor.is_moving ?
                '<span class="status-ok">Moving</span><span class="moving-indicator"></span>' :
                '<span>Idle</span>';

            const speedPercent = Math.min((sensor.speed_mm_per_s || 0) / 100 * 100, 100);
            const speedText = `${(sensor.speed_mm_per_s || 0).toFixed(1)} mm/s`;

            const cardClass = `sensor-card ${!sensor.has_filament ? 'no-filament' : ''} ${sensor.is_moving ? 'moving' : ''}`;

            return `
                <div class="${cardClass}" id="sensor-${sensor.id}">
                    <div class="sensor-header">
                        <span>Sensor ${sensor.id}</span>
                        <span class="sensor-number">#${sensor.id}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üì¶ Filament Status:</span>
                        <span class="sensor-value">${filamentStatus}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üîÑ Movement:</span>
                        <span class="sensor-value">${movingStatus}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">‚ö° Speed:</span>
                        <span class="sensor-value">${speedText}</span>
                    </div>
                    <div class="speed-bar">
                        <div class="speed-fill" style="width: ${speedPercent}%"></div>
                        <span class="speed-text">${speedText}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üî¢ Pulse Count:</span>
                        <span class="sensor-value">${sensor.pulse_count || 0}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üìè Total Usage:</span>
                        <span class="sensor-value">${(sensor.usage_meters || 0).toFixed(3)}m</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">‚ö†Ô∏è Runout Events:</span>
                        <span class="sensor-value ${sensor.runout_events > 0 ? 'status-warning' : ''}">${sensor.runout_events || 0}</span>
                    </div>
                </div>
            `;
        }

        // Update specific sensor values without recreating DOM
        function updateSensorValues(sensorId, sensor) {
            const card = document.getElementById(`sensor-${sensorId}`);
            if (!card) return false;

            // Update classes
            if (sensor.has_filament) {
                card.classList.remove('no-filament');
            } else {
                card.classList.add('no-filament');
            }
            if (sensor.is_moving) {
                card.classList.add('moving');
            } else {
                card.classList.remove('moving');
            }

            // Update filament status
            const filamentElem = card.querySelector('.filament-status');
            if (filamentElem) {
                filamentElem.innerHTML = sensor.has_filament ?
                    '<span class="status-ok">‚úì Filament OK</span>' :
                    '<span class="status-error">‚úó NO FILAMENT!</span>';
            }

            // Update movement status
            const movementElem = card.querySelector('.movement-status');
            if (movementElem) {
                movementElem.innerHTML = sensor.is_moving ?
                    '<span class="status-ok">Moving</span><span class="moving-indicator"></span>' :
                    '<span>Idle</span>';
            }

            // Update speed
            const speedElem = card.querySelector('.speed-value');
            const speedBarElem = card.querySelector('.speed-fill');
            const speedTextElem = card.querySelector('.speed-text');
            if (speedElem) {
                const speedText = `${(sensor.speed_mm_per_s || 0).toFixed(1)} mm/s`;
                speedElem.textContent = speedText;
                if (speedBarElem) {
                    const speedPercent = Math.min((sensor.speed_mm_per_s || 0) / 100 * 100, 100);
                    speedBarElem.style.width = `${speedPercent}%`;
                }
                if (speedTextElem) {
                    speedTextElem.textContent = speedText;
                }
            }

            // Update pulse count
            const pulseElem = card.querySelector('.pulse-count');
            if (pulseElem) {
                pulseElem.textContent = sensor.total_pulse_count || sensor.pulse_count || 0;
            }

            // Update usage
            const usageElem = card.querySelector('.usage-value');
            if (usageElem) {
                usageElem.textContent = `${(sensor.total_usage_meters || sensor.usage_meters || 0).toFixed(3)}m`;
            }

            // Update runout events
            const runoutElem = card.querySelector('.runout-events');
            if (runoutElem) {
                runoutElem.textContent = sensor.runout_events || 0;
                if (sensor.runout_events > 0) {
                    runoutElem.classList.add('status-warning');
                } else {
                    runoutElem.classList.remove('status-warning');
                }
            }

            return true;
        }

        // Create sensor card with data attributes for updating
        function createSensorCardInitial(sensor) {
            const filamentStatus = sensor.has_filament ?
                '<span class="status-ok">‚úì Filament OK</span>' :
                '<span class="status-error">‚úó NO FILAMENT!</span>';

            const movingStatus = sensor.is_moving ?
                '<span class="status-ok">Moving</span><span class="moving-indicator"></span>' :
                '<span>Idle</span>';

            const speedPercent = Math.min((sensor.speed_mm_per_s || 0) / 100 * 100, 100);
            const speedText = `${(sensor.speed_mm_per_s || 0).toFixed(1)} mm/s`;

            const cardClass = `sensor-card ${!sensor.has_filament ? 'no-filament' : ''} ${sensor.is_moving ? 'moving' : ''}`;

            return `
                <div class="${cardClass}" id="sensor-${sensor.id}">
                    <div class="sensor-header">
                        <span>Sensor ${sensor.id}</span>
                        <span class="sensor-number">#${sensor.id}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üì¶ Filament Status:</span>
                        <span class="sensor-value filament-status">${filamentStatus}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üîÑ Movement:</span>
                        <span class="sensor-value movement-status">${movingStatus}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">‚ö° Speed:</span>
                        <span class="sensor-value speed-value">${speedText}</span>
                    </div>
                    <div class="speed-bar">
                        <div class="speed-fill" style="width: ${speedPercent}%"></div>
                        <span class="speed-text">${speedText}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üî¢ Pulse Count:</span>
                        <span class="sensor-value pulse-count">${sensor.total_pulse_count || sensor.pulse_count || 0}</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">üìè Total Usage:</span>
                        <span class="sensor-value usage-value">${(sensor.total_usage_meters || sensor.usage_meters || 0).toFixed(3)}m</span>
                    </div>
                    <div class="sensor-stat">
                        <span class="sensor-label">‚ö†Ô∏è Runout Events:</span>
                        <span class="sensor-value runout-events ${sensor.runout_events > 0 ? 'status-warning' : ''}">${sensor.runout_events || 0}</span>
                    </div>
                </div>
            `;
        }

        // Update dashboard with smooth transitions
        function updateDashboard() {
            const startTime = performance.now();

            fetch('/status')
                .then(response => {
                    if (!response.ok) throw new Error('API response not OK');
                    return response.json();
                })
                .then(data => {
                    // Reset error count on successful fetch
                    errorCount = 0;
                    document.getElementById('error-message').style.display = 'none';

                    // Update connection status
                    const connectionDot = document.getElementById('connection-dot');
                    connectionDot.classList.remove('disconnected');
                    connectionDot.classList.add('connected');
                    document.getElementById('connection-status').innerHTML = '<span class="status-ok">Connected</span>';

                    // Update uptime
                    document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds || 0);

                    // Calculate total usage and active sensors
                    let totalUsage = 0;
                    let activeSensors = 0;
                    data.sensors.forEach(s => {
                        totalUsage += s.total_usage_meters || s.usage_meters || 0;
                        if (s.has_filament) activeSensors++;
                    });

                    document.getElementById('total-usage').textContent = totalUsage.toFixed(3) + 'm';
                    document.getElementById('active-sensors').textContent = `${activeSensors}/2`;

                    // Update sensor cards
                    const container = document.getElementById('sensors-container');

                    data.sensors.forEach(sensor => {
                        const existingCard = document.getElementById(`sensor-${sensor.id}`);

                        if (existingCard) {
                            // Update existing card values only
                            updateSensorValues(sensor.id, sensor);
                        } else {
                            // Create new card
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = createSensorCardInitial(sensor);
                            container.appendChild(tempDiv.firstElementChild);
                        }

                        // Check for significant changes and log them
                        if (lastData) {
                            const lastSensor = lastData.sensors.find(s => s.id === sensor.id);
                            if (lastSensor) {
                                if (lastSensor.has_filament !== sensor.has_filament) {
                                    addLogEntry(`Sensor ${sensor.id}: Filament ${sensor.has_filament ? 'inserted' : 'runout detected'}`);
                                }
                                if (!lastSensor.is_moving && sensor.is_moving) {
                                    addLogEntry(`Sensor ${sensor.id}: Movement started`);
                                }
                                if (lastSensor.is_moving && !sensor.is_moving) {
                                    addLogEntry(`Sensor ${sensor.id}: Movement stopped`);
                                }
                            }
                        }
                    });

                    // Update last response time
                    const responseTime = Math.round(performance.now() - startTime);
                    document.getElementById('last-response').textContent = `${responseTime}ms`;

                    // Store last data for comparison
                    lastData = data;
                })
                .catch(error => {
                    errorCount++;

                    // Show error after 3 failed attempts
                    if (errorCount > 3) {
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('connection-status').innerHTML = '<span class="status-error">Disconnected</span>';

                        const connectionDot = document.getElementById('connection-dot');
                        connectionDot.classList.remove('connected');
                        connectionDot.classList.add('disconnected');

                        addLogEntry('Connection lost to API');
                    }

                    document.getElementById('last-response').textContent = 'Error';
                });
        }

        // Initialize and start updates
        function initialize() {
            // Initial update
            updateDashboard();

            // Set up periodic updates (1 second interval)
            updateInterval = setInterval(updateDashboard, 1000);

            // Show activity log if needed
            // document.getElementById('activity-log').style.display = 'block';

            // Add page visibility handler to pause updates when page is hidden
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    clearInterval(updateInterval);
                } else {
                    updateDashboard();
                    updateInterval = setInterval(updateDashboard, 1000);
                }
            });
        }

        // Start when page loads
        window.addEventListener('load', initialize);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>